(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[289],{3905:(e,t,n)=>{"use strict";n.d(t,{Zo:()=>c,kt:()=>m});var s=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,s,a=function(e,t){if(null==e)return{};var n,s,a={},i=Object.keys(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=s.createContext({}),u=function(e){var t=s.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=u(e.components);return s.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},d=s.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,c=r(e,["components","mdxType","originalType","parentName"]),d=u(n),m=a,h=d["".concat(l,".").concat(m)]||d[m]||p[m]||i;return n?s.createElement(h,o(o({ref:t},c),{},{components:n})):s.createElement(h,o({ref:t},c))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r.mdxType="string"==typeof e?e:a,o[1]=r;for(var u=2;u<i;u++)o[u]=n[u];return s.createElement.apply(null,o)}return s.createElement.apply(null,n)}d.displayName="MDXCreateElement"},85034:(e,t,n)=>{"use strict";n.d(t,{V:()=>i});var s=n(67294);function a({children:e,severity:t}){return s.createElement("span",{style:{backgroundColor:`var(--ifm-color-${t})`,borderRadius:"2px",color:"var(--ifm-alert-color)",padding:"0.3rem",marginRight:"0.2rem"}},e)}function i({deprecated:e,removed:t}){return s.createElement("p",{style:{fontWeight:"bold"}},s.createElement(a,{severity:"warning"},"Deprecated:"),s.createElement("a",{href:"https://github.com/TypeScriptToLua/TypeScriptToLua/blob/master/CHANGELOG.md#"+e},e)," ",s.createElement(a,{severity:"danger"},"Removed:"),s.createElement("a",{href:"https://github.com/TypeScriptToLua/TypeScriptToLua/blob/master/CHANGELOG.md#"+t},t))}},26e3:(e,t,n)=>{"use strict";n.d(t,{q:()=>i});var s=n(67294);const a="sideBySide_3jwM";function i({children:e}){const t=s.Children.count(e);if(2!==t)throw new Error(`Invalid SideBySide children count: ${t}`);const[n,i]=s.Children.toArray(e);return s.createElement("div",{className:a},n,i)}},50812:(e,t,n)=>{"use strict";n.r(t),n.d(t,{frontMatter:()=>i,metadata:()=>o,toc:()=>r,default:()=>u});var s=n(22122),a=(n(67294),n(3905));n(26e3),n(85034);const i={title:"Automated Testing"},o={unversionedId:"advanced/automated-testing",id:"advanced/automated-testing",isDocsHomePage:!1,title:"Automated Testing",description:"This guide is going to explore unit testing, it\u2019s assuming some familiarity with the subject, but it\u2019s not required.",source:"@site/docs/advanced/automated-testing.md",sourceDirName:"advanced",slug:"/advanced/automated-testing",permalink:"/TypeScriptToLua.github.io/docs/advanced/automated-testing",editUrl:"https://github.com/TypeScriptToLua/TypeScriptToLua.github.io/edit/source/docs/advanced/automated-testing.md",version:"current",frontMatter:{title:"Automated Testing"},sidebar:"docs",previous:{title:"Language extensions",permalink:"/TypeScriptToLua.github.io/docs/advanced/language-extensions"},next:{title:"JSX",permalink:"/TypeScriptToLua.github.io/docs/jsx"}},r=[{value:"Automating the testing",id:"automating-the-testing",children:[]},{value:"TSTL Library specifics",id:"tstl-library-specifics",children:[]},{value:"An Example Repository",id:"an-example-repository",children:[]}],l={toc:r};function u({components:e,...t}){return(0,a.kt)("wrapper",(0,s.Z)({},l,t,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"This guide is going to explore unit testing, it\u2019s assuming some familiarity with the subject, but it\u2019s not required."),(0,a.kt)("p",null,"So to start off, you\u2019re gonna need some project set up, the specifics don\u2019t really matter, you can just take these ideas and extrapolate them to your own needs, but for demonstration I\u2019m going to have a basic project set up like this:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Project setup",src:n(6933).Z})),(0,a.kt)("p",null,"Our code is very simple for this example."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"title=index.ts",title:"index.ts"},'export const libraryFunction = (param: number[], reverse: boolean) => {\n  let reversed: number[] = [];\n\n  if (reverse) {\n    param.forEach((n) => table.insert(reversed, 1, n));\n  } else {\n    reversed = param;\n  }\n\n  return table.concat(reversed, ",");\n};\n')),(0,a.kt)("p",null,"So our function takes an array of numbers like \u201c","[1,2,3,4]","\u201d and returns a string like \u201c1,2,3,4\u201d or \u201c4,3,2,1\u201dThis is where unit testing comes in, say a piece of code depends on this function working like it does, and for it to keep working exactly like it does right now, obviously you could use the tried and true method of doing the testing yourself, but unit testing provides an alternative to the manual work."),(0,a.kt)("p",null,"So, automated testing, where do we begin?"),(0,a.kt)("p",null,"To start off we\u2019re going to need these tools installed:"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://luarocks.org/"},"https://luarocks.org/"),"\n&\n",(0,a.kt)("a",{parentName:"p",href:"https://olivinelabs.com/busted/"},"https://olivinelabs.com/busted/")),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"Luarocks is known to be hard to impossible to install on Windows systems sucessfully, if that\u2019s the case for you, definitely keep reading on, we\u2019re gonna explore a (free) option to do away with running tests locally entirely.")),(0,a.kt)("p",null,"Now that we have busted installed and the ",(0,a.kt)("inlineCode",{parentName:"p"},"busted")," command runs in your terminal of choice successfully we can proceed."),(0,a.kt)("p",null,"Let\u2019s quickly install busted typings like so ",(0,a.kt)("inlineCode",{parentName:"p"},"npm install -d busted-tstl")),(0,a.kt)("p",null,"And we need to add busted-tstl types to our tsconfig.json, you should already have a section like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json",metastring:"title=tsconfig.json",title:"tsconfig.json"},'"types": [\n  "typescript-to-lua/language-extensions",\n  "lua-types/jit",\n]\n')),(0,a.kt)("p",null,"Simply add ",(0,a.kt)("inlineCode",{parentName:"p"},'"busted-tstl"')," :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json",metastring:"title=tsconfig.json",title:"tsconfig.json"},'"types": [\n  "typescript-to-lua/language-extensions",\n  "lua-types/jit",\n  "busted-tstl"\n]\n')),(0,a.kt)("p",null,"Now let\u2019s set up a folder for our tests, by default busted takes a folder named ",(0,a.kt)("inlineCode",{parentName:"p"},"spec")," and runs the files in there, now\nthis is personal preference, but usually I name my tests ",(0,a.kt)("inlineCode",{parentName:"p"},"[filename to be tested]_spec.ts"),", the ","_","spec suffix is once again what busted searches for by default, so we\u2019ll stick to that."),(0,a.kt)("p",null,"Now our project should look something like this:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Project setup",src:n(27813).Z})),(0,a.kt)("p",null,"Alright, we can start writing our first test. Let\u2019s explore the following example briefly:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"title=index_spec.ts",title:"index_spec.ts"},'import { libraryFunction } from "..";\n\ndescribe("Library Function", () => {\n  it("Returns unreversed string correctly", () => {\n    assert.is_equal("1,2,3,4", libraryFunction([1, 2, 3, 4], false));\n  });\n});\n')),(0,a.kt)("p",null,"So the short version of what\u2019s happening there is the \u2018describe\u2019 block is our named collection of tests, this block pertains to the library function and library function alone, next we call it(\u2018\u2019,()=>{}) in there to name and describe the behaviour of a single test, it\u2019s a regular function so you can call and do anything in there. Right here, we\u2019re just using a function in the assert namespace which passes the test if the 2 parameters are exactly equal, and fails if they\u2019re different."),(0,a.kt)("p",null,"Alright, so we call our libraryFunction with a set of parameters, and get back some return, then we assert that the return value is equal to a known (correct) value. For illustration let\u2019s add another test, since we have a second signature of the function that returns a reversed string, we can try that:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript",metastring:"title=index_spec.ts",title:"index_spec.ts"},'import { libraryFunction } from "..";\n\ndescribe("Library Function", () => {\n  it("Returns unreversed string correctly", () => {\n    assert.is_equal("1,2,3,4", libraryFunction([1, 2, 3, 4], false));\n  });\n  it("Returns unreversed string correctly", () => {\n    assert.is_equal("4,3,2,1", libraryFunction([1, 2, 3, 4], true));\n  });\n});\n')),(0,a.kt)("p",null,"Now hit compile and change your terminal\u2019s directory in to your tstl output folder, for me it\u2019s the ",(0,a.kt)("inlineCode",{parentName:"p"},"dist")," folder.\nWe can now just simply run ",(0,a.kt)("inlineCode",{parentName:"p"},"busted"),", and you should see something like this:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Project setup",src:n(70656).Z})),(0,a.kt)("p",null,"2 tests succeeded, so our code is working as expected for these 2 scenarios, of course these aren\u2019t exhaustive, for some real functionality they would be more exhaustive, more scenarios and validation, but this should set you on your tracks of busted testing your code."),(0,a.kt)("p",null,"Now we can move on to the next topic"),(0,a.kt)("h2",{id:"automating-the-testing"},"Automating the testing"),(0,a.kt)("p",null,"For this we\u2019re going to use the free tools provided by GitHub to every public(and most private?) repository, this assumes you already have a git repository hosted on GitHub, if you need help doing that I can point you to their exhaustive docs:"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://docs.github.com/en/get-started/quickstart"},"https://docs.github.com/en/get-started/quickstart")),(0,a.kt)("p",null,"And also the documentation about actions specifically:"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions"},"https://docs.github.com/en/actions")),(0,a.kt)("p",null,"So, first we\u2019re going to create a workflow file"),(0,a.kt)("p",null,"Set up a folder structure like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Root project folder/\n  .github/\n    workflows/\n      testing.yml\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml",metastring:"title=testing.yml",title:"testing.yml"},'name: TSTL Testing\n\non:\n  push:\n    branches: [main]\n  pull_request:\n    branches: [main]\n\njobs:\n  build_tests:\n    name: Busted Tests\n    runs-on: ubuntu-latest\n\n    steps:\n      - uses: actions/checkout@v2\n      - name: Use Node.js [16.x]\n        uses: actions/setup-node@v2\n        with:\n          node-version: 16.x\n          cache: "npm"\n      - name: Npm Install && Build with Testing preset\n        run: npm install && npm run-script build\n      - name: Install Lua\n        uses: leafo/gh-actions-lua@v8\n        with:\n          luaVersion: "luajit-2.1.0-beta3"\n      - name: Install LuaRocks\n        uses: leafo/gh-actions-luarocks@v4.0.0\n      - name: Install Busted\n        run: luarocks install busted\n      - name: Running Tests\n        run: cd dist && busted\n')),(0,a.kt)("p",null,"Without going in to much detail, this workflow triggers whenever you push a commit to your github repository, installs Node.js, Lua, Luarocks and Busted installs all of your project dependencies and compiles a fresh version of the project, at the very end it moves in to the dist folder and runs your busted tests exactly like you would. Now, if you commit and push these changes to your GitHub repository you should be able to see, Under the Actions tab at the top, something like this:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Github action result",src:n(68379).Z})),(0,a.kt)("p",null,"Now that\u2019s just it, this job will run every time you push a new commit to the repository, if it fails it\u2019ll show up as a red cross, and you can find which test failed in the logs."),(0,a.kt)("h2",{id:"tstl-library-specifics"},"TSTL Library specifics"),(0,a.kt)("p",null,"This section applies to projects described in ",(0,a.kt)("a",{parentName:"p",href:"/TypeScriptToLua.github.io/docs/publishing-modules"},"Publishing Modules"),", as you might know, library projects don\u2019t (and shouldn\u2019t) include the luaLibBundle and also any dependencies it would need to run, so how do we make it run standalone, for testing, we\u2019re going to utilize the fact that you can pass in a different ",(0,a.kt)("inlineCode",{parentName:"p"},"tsconfig.json")," to the compiler, so, the regular one is implicitly used based on the name ",(0,a.kt)("inlineCode",{parentName:"p"},"tsconfig.json"),", we\u2019re going to create a new one like ",(0,a.kt)("inlineCode",{parentName:"p"},"tsconfig.test.json")," you can pretty much duplicate it from your current one, we\u2019re just going to change a few values:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json",metastring:"title=tsconfig.test.json",title:"tsconfig.test.json"},'{\n  "compilerOptions": {\n    "lib": ["esnext"],\n    "rootDir": "src",\n    "outDir": "dist" => "testing",\n    "target": "esnext",\n    "moduleResolution": "node",\n    "types": [\n      "typescript-to-lua/language-extensions",\n      "lua-types/jit",\n      "busted-tstl"\n    ],\n    "declaration": true,\n    "noImplicitAny": true,\n  },\n  "tstl": {\n    "luaLibImport": "none" => "require",\n    "buildMode": "library" => "default",\n    "luaTarget": "JIT",\n    "noImplicitSelf": true,\n    "sourceMapTraceback": false\n  }\n}\n')),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"(arrows are to indicate the changes, don't include them in the actual code)")),(0,a.kt)("p",null,"Now you can use this new tsconfig like: ",(0,a.kt)("inlineCode",{parentName:"p"},"tstl \u2014project tsconfig.test.json")),(0,a.kt)("p",null,"It will output the new build in to the testing folder and you can move your terminal in to the folder and run busted"),(0,a.kt)("p",null,"Then you can edit your ",(0,a.kt)("inlineCode",{parentName:"p"},"package.json")," file and add a new task:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json",metastring:"title=package.json",title:"package.json"},'"scripts": {\n  "build": "tstl",\n  + "test-build": "tstl --project tsconfig.test.json",\n  "dev": "tstl --watch"\n},\n')),(0,a.kt)("p",null,"Next we\u2019ll edit our GitHub actions workflow file to work with this new command like so:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yaml",metastring:"title=testing.yml",title:"testing.yml"},'name: TSTL Testing\n\non:\n  push:\n    branches: [main]\n  pull_request:\n    branches: [main]\n\njobs:\n  build_tests:\n    name: Busted Tests\n    runs-on: ubuntu-latest\n\n    steps:\n      - uses: actions/checkout@v2\n      - name: Use Node.js [16.x]\n        uses: actions/setup-node@v2\n        with:\n          node-version: 16.x\n          cache: "npm"\n      - name: Npm Install && Build with Testing preset\n        run: npm install && npm run-script test-build\n      - name: Install Lua\n        uses: leafo/gh-actions-lua@v8\n        with:\n          luaVersion: "luajit-2.1.0-beta3"\n      - name: Install LuaRocks\n        uses: leafo/gh-actions-luarocks@v4.0.0\n      - name: Install Busted\n        run: luarocks install busted\n      - name: Running Tests\n        run: cd testing && busted\n')),(0,a.kt)("p",null,"Now your build should include all the Lua libraries you installed with npm/yarn, include the lualib bundle file and the GitHub action should work."),(0,a.kt)("h2",{id:"an-example-repository"},"An Example Repository"),(0,a.kt)("p",null,"If some things are still unclear you can always check a repository that followed this guide: ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/qeffects/tstl-testing"},"https://github.com/qeffects/tstl-testing")))}u.isMDXComponent=!0},70656:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});const s=n.p+"assets/images/busted-output-7d528e6aae9a3b91e7fd053d172c7a5e.png"},68379:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});const s=n.p+"assets/images/github-workflow-result-ae94d7ffb2dd69f17e6389f50503d8f6.png"},27813:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});const s=n.p+"assets/images/testing-project-setup-with-spec-folder-ffb798a40f552d8c9f1e8dcc2bea63a9.png"},6933:(e,t,n)=>{"use strict";n.d(t,{Z:()=>s});const s=n.p+"assets/images/testing-project-setup-f79024f66fd4a4f08224cf2212ddd166.png"}}]);